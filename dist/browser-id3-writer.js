!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ID3Writer=t()}(this,function(){"use strict";function u(e,t){var r;if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator])return(r=e[Symbol.iterator]()).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function r(e){return String(e).split("").map(function(e){return e.charCodeAt(0)})}function l(e){return new Uint8Array(r(e))}function h(e){var t=new Uint8Array(2*e.length);return new Uint16Array(t.buffer).set(r(e)),t}function f(e){var t=255;return[e>>>24&t,e>>>16&t,e>>>8&t,e&t]}function s(e){return 13+2*e}function i(e,t){return 13+2*e+2+2+2*t}return function(){var e=t.prototype;function t(e){if(!(e&&"object"==typeof e&&"byteLength"in e))throw new Error("First argument should be an instance of ArrayBuffer or Buffer");this.arrayBuffer=e,this.padding=4096,this.frames=[],this.url=""}return e._setIntegerFrame=function(e,t){var r=parseInt(t,10);this.frames.push({name:e,value:r,size:11+r.toString().length})},e._setStringFrame=function(e,t){var r=t.toString();this.frames.push({name:e,value:r,size:s(r.length)})},e._setPictureFrame=function(e,t,r){this.frames.push(this._createPictureFrame(e,t,r))},e._createPictureFrame=function(e,t,r){var a,n,s,i,c=function(e){if(!e||!e.length)return null;if(255===e[0]&&216===e[1]&&255===e[2])return"image/jpeg";if(137===e[0]&&80===e[1]&&78===e[2]&&71===e[3])return"image/png";if(71===e[0]&&73===e[1]&&70===e[2])return"image/gif";if(87===e[8]&&69===e[9]&&66===e[10]&&80===e[11])return"image/webp";var t=73===e[0]&&73===e[1]&&42===e[2]&&0===e[3],r=77===e[0]&&77===e[1]&&0===e[2]&&42===e[3];return t||r?"image/tiff":66===e[0]&&77===e[1]?"image/bmp":0===e[0]&&0===e[1]&&1===e[2]&&0===e[3]?"image/x-icon":null}(new Uint8Array(t)),o=r.toString();if(!c)throw new Error("Unknown picture MIME type");return{name:"APIC",value:t,pictureType:e,mimeType:c,description:o,size:(a=t.byteLength,n=c.length,s=o.length,11+n+1+1+(i?2+2*(s+1):s+1)+a)}},e._setLyricsFrame=function(e,t,r){var a,n,s=e.split("").map(function(e){return e.charCodeAt(0)}),i=t.toString(),c=r.toString();this.frames.push({name:"USLT",value:c,language:s,description:i,size:(a=i.length,n=c.length,16+2*a+2+2+2*n)})},e._setCommentFrame=function(e,t,r){var a,n,s=e.split("").map(function(e){return e.charCodeAt(0)}),i=t.toString(),c=r.toString();this.frames.push({name:"COMM",value:c,language:s,description:i,size:(a=i.length,n=c.length,16+2*a+2+2+2*n)})},e._setPrivateFrame=function(e,t){var r,a,n=e.toString();this.frames.push({name:"PRIV",value:t,id:n,size:(r=n.length,a=t.byteLength,10+r+1+a)})},e._setUserDefinedUrlLinkFrame=function(e,t){var r=e.toString(),a=t.toString();this.frames.push({name:"TXXX",description:r,value:a,size:i(r.length,a.length)})},e._setUserStringFrame=function(e,t){var r=e.toString(),a=t.toString();this.frames.push({name:"TXXX",description:r,value:a,size:i(r.length,a.length)})},e._setUrlLinkFrame=function(e,t){var r=t.toString();this.frames.push({name:e,value:r,size:10+r.length})},e._setChapterFrame=function(e){var a=this,t=e.subFrames.map(function(e){var t=e.id,r=e.params;switch(t){case"APIC":return a._validateAPIC(r),a._createPictureFrame(r.type,r.data,r.description);case"TIT2":case"TIT3":return{name:t,value:r,size:s(r.length)};default:return null}}).filter(function(e){return e});this.frames.push({name:"CHAP",id:e.id,startTime:e.startTime,endTime:e.endTime,startOffset:e.startOffset,endOffset:e.endOffset,subFrames:t,size:10+(e.id.length+1+16)+t.map(function(e){return e.size}).reduce(function(e,t){return e+t},0)})},e._setToCFrame=function(e){var t,r,a,n=e.subFrames.map(function(e){var t=e.id,r=e.params;switch(t){case"TIT2":case"TIT3":return{name:t,value:r,size:s(r.length)};default:return null}}).filter(function(e){return e});this.frames.push({name:"CTOC",id:e.id,ordered:e.ordered,topLevel:e.topLevel,childElementIds:e.childElementIds,subFrames:n,size:(t=e.id.length,r=e.childElementIds,a=n,10+(t+1+1+1)+r.map(function(e){return e.length+1}).reduce(function(e,t){return e+t},0)+a.map(function(e){return e.size}).reduce(function(e,t){return e+t},0))})},e._validateAPIC=function(e){if(!("object"==typeof e&&"type"in e&&"data"in e&&"description"in e))throw new Error("APIC frame value should be an object with keys type, data and description");if(e.type<0||20<e.type)throw new Error("Incorrect APIC frame picture type")},e._setSynchronisedLyricsFrame=function(e,t,r,a,n){var s,i,c,o=a.split("").map(function(e){return e.charCodeAt(0)});this.frames.push({name:"SYLT",value:t,language:o,type:e,descriptor:n,timestampFormat:r,size:(s=t,i=2*n.length+2+2,c=0,s.forEach(function(e){c+=2+2*e[0].length+2+4}),16+c+i),__type__:"SYLT"})},e.setFrame=function(e,t){switch(e){case"TPE1":case"TCOM":case"TCON":if(!Array.isArray(t))throw new Error(e+" frame value should be an array of strings");var r="TCON"===e?";":"/",a=t.join(r);this._setStringFrame(e,a);break;case"TLAN":case"TIT1":case"TIT2":case"TIT3":case"TALB":case"TPE2":case"TPE3":case"TPE4":case"TRCK":case"TPOS":case"TMED":case"TPUB":case"TCOP":case"TKEY":case"TEXT":case"TSRC":case"TENC":this._setStringFrame(e,t);break;case"TBPM":case"TLEN":case"TDAT":case"TYER":this._setIntegerFrame(e,t);break;case"USLT":if(t.language=t.language||"eng",!("object"==typeof t&&"description"in t&&"lyrics"in t))throw new Error("USLT frame value should be an object with keys description and lyrics");if(t.language&&!t.language.match(/[a-z]{3}/i))throw new Error("Language must be coded following the ISO 639-2 standards");this._setLyricsFrame(t.language,t.description,t.lyrics);break;case"SYLT":if(t.language=t.language||"eng",!("object"==typeof t&&"type"in t&&"text"in t&&"timestampFormat"in t))throw new Error("SYLT frame value should be an object with keys type, text and timestampFormat");if(!Array.isArray(t.text)||!Array.isArray(t.text[0]))throw new Error("SYLT frame text value should be an array of pairs");if(t.type<0||6<t.type)throw new Error("Incorrect SYLT frame content type");if(t.timestampFormat<1||2<t.timestampFormat)throw new Error("Incorrect SYLT frame time stamp format");this._setSynchronisedLyricsFrame(t.type,t.text,t.timestampFormat,t.language,t.descriptor);break;case"APIC":this._validateAPIC(t),this._setPictureFrame(t.type,t.data,t.description,!!t.useUnicodeEncoding);break;case"TXXX":if(!("object"==typeof t&&"description"in t&&"value"in t))throw new Error("TXXX frame value should be an object with keys description and value");this._setUserStringFrame(t.description,t.value);break;case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":this._setUrlLinkFrame(e,t);break;case"COMM":if(t.language=t.language||"eng",!("object"==typeof t&&"description"in t&&"text"in t))throw new Error("COMM frame value should be an object with keys description and text");if(t.language&&!t.language.match(/[a-z]{3}/i))throw new Error("Language must be coded following the ISO 639-2 standards");this._setCommentFrame(t.language,t.description,t.text);break;case"PRIV":if(!("object"==typeof t&&"id"in t&&"data"in t))throw new Error("PRIV frame value should be an object with keys id and data");this._setPrivateFrame(t.id,t.data);break;case"CHAP":this._setChapterFrame(t);break;case"CTOC":this._setToCFrame(t);break;default:throw new Error("Unsupported frame "+e)}return this},e.removeTag=function(){var e,t,r,a,n;this.arrayBuffer.byteLength<10||(t=(e=new Uint8Array(this.arrayBuffer))[3],r=((a=[e[6],e[7],e[8],e[9]])[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+10,73!==(n=e)[0]||68!==n[1]||51!==n[2]||t<2||4<t||(this.arrayBuffer=new Uint8Array(e.subarray(r)).buffer))},e.addTag=function(){this.removeTag();var e,t,s=[255,254],r=10+this.frames.reduce(function(e,t){return e+t.size},0)+this.padding,a=new ArrayBuffer(this.arrayBuffer.byteLength+r),i=new Uint8Array(a),c=0,o=[],o=[73,68,51,3];i.set(o,c),c+=o.length,c++,c++,o=[(e=r-10)>>>21&(t=127),e>>>14&t,e>>>7&t,e&t],i.set(o,c),c+=o.length;return this.frames.forEach(function e(t){switch(o=l(t.name),i.set(o,c),c+=o.length,o=f(t.size-10),i.set(o,c),c+=o.length,c+=2,t.name){case"WCOM":case"WCOP":case"WOAF":case"WOAR":case"WOAS":case"WORS":case"WPAY":case"WPUB":o=l(t.value),i.set(o,c),c+=o.length;break;case"TPE1":case"TCOM":case"TCON":case"TLAN":case"TIT1":case"TIT2":case"TIT3":case"TALB":case"TPE2":case"TPE3":case"TPE4":case"TRCK":case"TPOS":case"TKEY":case"TMED":case"TPUB":case"TCOP":case"TEXT":case"TSRC":case"TENC":o=[1].concat(s),i.set(o,c),c+=o.length,o=h(t.value),i.set(o,c),c+=o.length;break;case"TXXX":case"USLT":case"COMM":o=[1],"USLT"!==t.name&&"COMM"!==t.name||(o=o.concat(t.language)),o=o.concat(s),i.set(o,c),c+=o.length,o=h(t.description),i.set(o,c),c+=o.length,o=[0,0].concat(s),i.set(o,c),c+=o.length,o=h(t.value),i.set(o,c),c+=o.length;break;case"TBPM":case"TLEN":case"TDAT":case"TYER":c++,o=l(t.value),i.set(o,c),c+=o.length;break;case"PRIV":o=l(t.id),i.set(o,c),c+=o.length,c++,i.set(new Uint8Array(t.value),c),c+=t.value.byteLength;break;case"APIC":o=[t.useUnicodeEncoding?1:0],i.set(o,c),c+=o.length,o=l(t.mimeType),i.set(o,c),c+=o.length,o=[0,t.pictureType],i.set(o,c),c+=o.length,t.useUnicodeEncoding?(o=[].concat(s),i.set(o,c),c+=o.length,o=h(t.description),i.set(o,c),c+=o.length,c+=2):(o=l(t.description),i.set(o,c),c+=o.length,c++),i.set(new Uint8Array(t.value),c),c+=t.value.byteLength;break;case"SYLT":o=(o=(o=(o=[1]).concat(t.language)).concat(t.timestampFormat)).concat(t.type),i.set(o,c),c+=o.length,o=[].concat(s),i.set(o,c),c+=o.length,o=h(t.descriptor),i.set(o,c),c+=o.length,o=[0,0],i.set(o,c),c+=o.length;for(var r,a=u(t.value);!(r=a()).done;){var n=r.value;o=[].concat(s),i.set(o,c),c+=o.length,o=h(n[0].toString()),i.set(o,c),c+=o.length,o=[0,0],i.set(o,c),c+=o.length,o=f(n[1]),i.set(o,c),c+=o.length}break;case"CHAP":o=l(t.id+"\0"),i.set(o,c),c+=o.length,o=f(t.startTime),i.set(o,c),c+=o.length,o=f(t.endTime),i.set(o,c),c+=o.length,o=f(t.startOffset),i.set(o,c),c+=o.length,o=f(t.endOffset),i.set(o,c),c+=o.length,t.subFrames.forEach(e);break;case"CTOC":o=l(t.id+"\0"),i.set(o,c),c+=o.length,i.set([(t.topLevel?2:0)|(t.ordered?1:0)],c),c+=1,i.set([t.childElementIds.length],c),c+=1,t.childElementIds.forEach(function(e){o=l(e+"\0"),i.set(o,c),c+=o.length}),t.subFrames.forEach(e)}}),c+=this.padding,i.set(new Uint8Array(this.arrayBuffer),c),this.arrayBuffer=a},e.getBlob=function(){return new Blob([this.arrayBuffer],{type:"audio/mpeg"})},e.getURL=function(){return this.url||(this.url=URL.createObjectURL(this.getBlob())),this.url},e.revokeURL=function(){URL.revokeObjectURL(this.url)},t}()});